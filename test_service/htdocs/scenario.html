<!DOCTYPE html>
<html lang=en>
<head>
    <meta charset="utf-8"/>
    <script src="/load.js"></script>
    <script>
    require('/hlsi.css');
    require('/slider.js');
    require('/label.js');
    require('/scrollPlot.js');
    onload = function() {
        Session(function(io) {

            // If we have permission, this will start this program only if
            // a program with the name '/throttle' is not running already.
            io.Emit('launch', '/throttle'/*path*/,
                []/*args array*/, '/throttle'/*program Name*/);

            var controllers = Controllers(io);

            // Parameters we will get, or set and get.
            var period1 = controllers.Parameter('/throttle'/*program*/,
                    'throttle'/*filter*/, 'period'/*parameter*/);
            var period2 = controllers.Parameter('/throttle'/*program*/,
                    'secondThrottle'/*filter*/, 'period'/*parameter*/);
            var bytes = controllers.Parameter('/throttle',
                    'secondThrottle', 'totalBytesOut');


            Slider(period2, {suffix: " sec", prefix: "period2"});
            // Test building slider from querySelector
            Slider(period1, { parentNode: "#slider1", suffix: " seconds"});

            Label(bytes, { prefix: 'Total Bytes', suffix: 'bytes',
                digits: 0 });
            Label(bytes, { prefix: 'Total Bytes ', suffix: ' kbytes',
                scale: 1.0/1024.0, digits: 1 });
            Label(bytes, { prefix: 'Total Bytes ', suffix: ' Mbytes',
                scale: 1.0e-6, digits: 1 });

            ScrollPlot(period2, { yTicks: [ 0.0, 0.2, 0.4, 0.6, 0.8, 1.0 ]});

            ScrollPlot(period2, { 
                        yLog: true,
                        yTicks: [ 0.2, 0.4, 0.6, 0.8, 1.0 ],
                        yMin: 0.01,
                        yMax: 2.0,
                        yLabel: "Period2 (seconds)"
            });


            ///////////////////////////////////////////////////////////////////
            //  ScrollPlot with a crude time derivative
            //////////////////////////////////////////////////////////////////
            // We need some state data to calculate a rate in bits/second
            // We just can't let rateToPlot start at zero.
            var rateToPlot = 1.0; // bits/second

            var t0 = 0; // time in milliseconds
            var totalBytesOut0 = 0.0;
            const maxDt = 3.7e+3; // milliseconds

            bytes.addOnChange(function(val) {

                let t1 = Date.now();
                let dt = t1 - t0;

                // This is the simplest way to take a derivative, and
                // not likely the best.  A sliding average over more than
                // 2 points would be better and less wiggly.

                if(dt < maxDt && dt > 1.3e+3 && val > 1.1) {
                    // val is in bytes.  dt is in milliseconds.
                    // There are 8 bits for every byte.
                    // The rate of numbers coming in is about once
                    // every 1/2 second.
                    rateToPlot = 8000*(val - totalBytesOut0)/dt;

                    // Every time we use a new value we do this.
                    t0 = t1;
                    totalBytesOut0 = val;

                } else if(dt > maxDt) {
                    t0 = t1;
                    totalBytesOut0 = val;
                }
            });

            ScrollPlot(function() { return rateToPlot; }, { 
                    yLog: true,
                    autoScaleY: true,
                    yTicks: [
                        1e3, 2e3, 4e3,
                        1e4, 2e4, 4e4,
                        1e5
                       ],
                    yMin: 1e3,
                    yMax: 1e5,
                    yLabel: "bits/sec"
            });






        }, { 
            showHeader: true,
            loadCRTScss: false
        });
    };
    </script>
    <title>CRTS</title>
</head>
<body>

    <h4><a href=".">up</a></h4>

    <div id=slider1></div>

</body>
</html>
